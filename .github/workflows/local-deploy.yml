name: local-deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: local-deploy
  cancel-in-progress: true

jobs:
  deploy-local:
    runs-on: [self-hosted]
    timeout-minutes: 30
    env:
      SPRINT: sprint5
      DISABLE_LOGGING: "true"
      COMPOSE_PROJECT_NAME: localdeploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stop previous localdeploy stack (if any)
        shell: pwsh
        run: |
          docker compose -p $env:COMPOSE_PROJECT_NAME -f docker-compose.yml -f .github/docker-compose.local-deploy.yml down --remove-orphans

      - name: Deploy latest sprint5 locally with Docker Compose
        shell: pwsh
        run: |
          docker compose -p $env:COMPOSE_PROJECT_NAME -f docker-compose.yml -f .github/docker-compose.local-deploy.yml up -d --build --remove-orphans

      - name: Run migrations and seed data
        shell: pwsh
        run: |
          docker compose -p $env:COMPOSE_PROJECT_NAME -f docker-compose.yml -f .github/docker-compose.local-deploy.yml exec -T laravel-api php artisan migrate:fresh --seed

      - name: Verify API health endpoint
        shell: pwsh
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:8091/status" -UseBasicParsing
          if ($response.StatusCode -ne 200) {
            throw "API health check failed with status code $($response.StatusCode)"
          }

      - name: Verify UI endpoint
        shell: pwsh
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:14200" -UseBasicParsing
          if ($response.StatusCode -lt 200 -or $response.StatusCode -ge 400) {
            throw "UI check failed with status code $($response.StatusCode)"
          }

      - name: Show container status on failure
        if: failure()
        shell: pwsh
        run: |
          docker compose -p $env:COMPOSE_PROJECT_NAME -f docker-compose.yml -f .github/docker-compose.local-deploy.yml ps
          docker compose -p $env:COMPOSE_PROJECT_NAME -f docker-compose.yml -f .github/docker-compose.local-deploy.yml logs --tail=200